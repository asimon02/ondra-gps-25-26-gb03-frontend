<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex items-center justify-center min-h-screen">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
  </div>

  <!-- Song Not Found -->
  <div *ngIf="!isLoading && !song" class="flex items-center justify-center min-h-screen">
    <div class="text-center">
      <svg class="mx-auto h-24 w-24 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Cancion no encontrada</h2>
      <p class="text-gray-600 mb-6">Lo sentimos, no pudimos encontrar esta cancion.</p>
      <button
        (click)="goBack()"
        class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all shadow-md hover:shadow-lg font-medium"
      >
        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Volver atras
      </button>
    </div>
  </div>

  <!-- Song Detail Content -->
  <div *ngIf="!isLoading && song" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Back Button -->
    <button
      (click)="goBack()"
      class="inline-flex items-center text-gray-600 hover:text-blue-600 transition-colors mb-6 group"
    >
      <svg class="w-5 h-5 mr-2 transform group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      <span class="font-medium">Volver</span>
    </button>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
      <!-- Left Column: Cover and Actions -->
      <div class="lg:col-span-2 space-y-4">
        <!-- Cover Image with Play Button -->
        <div class="relative group max-w-sm mx-auto">
          <div class="bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-2xl overflow-hidden shadow-xl transform transition-all duration-300 hover:scale-[1.02]">
            <img
              [src]="song.coverUrl"
              [alt]="song.title"
              class="w-full aspect-square object-cover"
            />
          </div>

          <!-- Play Overlay -->
          <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 rounded-2xl flex items-center justify-center">
            <button
              (click)="onToggleSongPlayback()"
              class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 text-white flex items-center justify-center shadow-2xl shadow-blue-500/40 ring-4 ring-white/40 transform scale-0 group-hover:scale-100 transition-all duration-300 hover:scale-105"
              [attr.aria-label]="isCurrentSongPlaying ? 'Pausar cancion' : 'Reproducir cancion'"
              [attr.title]="isCurrentSongPlaying ? 'Pausar cancion' : 'Reproducir cancion'"
            >
              <ng-container *ngIf="isCurrentSongPlaying; else songDetailPlayIcon">
                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6 5h4v14H6zM14 5h4v14h-4z" />
                </svg>
              </ng-container>
              <ng-template #songDetailPlayIcon>
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              </ng-template>
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="space-y-2.5 max-w-sm mx-auto">
          <button
            (click)="onPurchase()"
            [disabled]="song.isPurchased"
            class="w-full flex items-center justify-center gap-2.5 px-5 py-3 rounded-xl font-semibold text-sm transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
            [class.bg-blue-600]="!song.isPurchased"
            [class.text-white]="!song.isPurchased"
            [class.hover:bg-blue-700]="!song.isPurchased"
            [class.bg-green-100]="song.isPurchased"
            [class.text-green-700]="song.isPurchased"
          >
            <svg *ngIf="!song.isPurchased" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <svg *ngIf="song.isPurchased" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            {{ song.isPurchased ? 'Ya comprada' : (song.price === 0 ? 'Obtener gratis' : ('Comprar ' + (song.price | currency:'EUR':'symbol':'1.2-2'))) }}
          </button>

          <button
            (click)="onToggleFavorite()"
            class="w-full flex items-center justify-center gap-3 bg-white px-6 py-4 rounded-xl font-semibold border-2 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
            [class.border-red-500]="song.isFavorite"
            [class.text-red-500]="song.isFavorite"
            [class.border-gray-200]="!song.isFavorite"
            [class.text-gray-700]="!song.isFavorite"
            [class.hover:border-red-500]="!song.isFavorite"
            [class.hover:text-red-500]="!song.isFavorite"
          >
            <svg class="w-5 h-5" [class.fill-current]="song.isFavorite" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                [attr.fill]="song.isFavorite ? 'currentColor' : 'none'"
                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
              />
            </svg>
            {{ song.isFavorite ? 'Favorito' : 'Anadir a favoritos' }}
          </button>

          <button
            (click)="onShare()"
            class="w-full flex items-center justify-center gap-3 bg-white text-gray-700 px-6 py-4 rounded-xl font-semibold border-2 border-gray-200 hover:border-blue-600 hover:text-blue-600 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
          >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
            </svg>
            Compartir
          </button>
        </div>
      </div>

      <!-- Right Column: Info and Player -->
      <div class="lg:col-span-3 space-y-6">
        <!-- Song Info -->
        <div class="bg-white rounded-3xl p-8 shadow-xl border border-gray-100">
          <h1 class="text-4xl font-bold text-gray-900 mb-3 leading-tight">{{ song.title }}</h1>
          <a
            [routerLink]="['/artist', song.artist.id]"
            class="text-xl text-gray-600 hover:text-blue-600 transition-colors inline-block mb-6 font-medium"
          >
            {{ song.artist.artisticName }}
          </a>

          <div class="flex items-center flex-wrap gap-3 mb-8">
            <span class="inline-flex items-center px-4 py-2 text-sm font-semibold text-blue-600 bg-blue-50 rounded-full">
              {{ song.genre }}
            </span>

            <!-- Album Link -->
            <a
              *ngIf="getAlbumInfo() as album"
              [routerLink]="['/album', album.id]"
              class="flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors px-3 py-1.5 bg-gray-50 rounded-full"
            >
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
              </svg>
              <span class="font-medium text-sm">{{ album.title }}</span>
            </a>

            <span class="flex items-center gap-2 text-gray-600">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {{ formatDuration(song.duration) }}
            </span>

            <span *ngIf="song.averageRating" class="flex items-center gap-2 text-gray-600">
              <svg class="w-4 h-4 text-yellow-400 fill-current" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              {{ song.averageRating.toFixed(1) }}
            </span>

            <span class="flex items-center gap-2 text-gray-600">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              {{ song.releaseDate | date:'yyyy' }}
            </span>
          </div>

          <div class="border-t-2 border-gray-100 pt-6">
            <h2 class="text-xl font-bold text-gray-900 mb-3">Sobre esta cancion</h2>
            <p class="text-gray-600 leading-relaxed">
              {{ song.description || 'No hay descripcion disponible para esta cancion.' }}
            </p>
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-3 gap-6 mt-8 pt-6 border-t-2 border-gray-100">
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-600 mb-1">{{ formatNumber(song.playCount) }}</div>
              <div class="text-sm text-gray-500 font-medium">Reproducciones</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-600 mb-1">{{ song.averageRating?.toFixed(1) || '0.0' }}</div>
              <div class="text-sm text-gray-500 font-medium">Valoracion</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-600 mb-1">{{ formatNumber(song.totalComments || 0) }}</div>
              <div class="text-sm text-gray-500 font-medium">Comentarios</div>
            </div>
          </div>
        </div>

        <!-- Rating Widget -->
        <rating-widget
          [contentId]="+song.id"
          type="song"
        ></rating-widget>

        <!-- Artist Info -->
        <div class="bg-white rounded-3xl p-8 shadow-xl border border-gray-100">
          <div class="flex items-center gap-5">
            <div class="w-16 h-16 rounded-full overflow-hidden bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-lg">
              <img
                *ngIf="song.artist.profileImage"
                [src]="song.artist.profileImage"
                [alt]="song.artist.artisticName"
                class="w-full h-full object-cover"
              />
              <span *ngIf="!song.artist.profileImage" class="text-white text-2xl font-bold">
                {{ song.artist.artisticName.charAt(0) }}
              </span>
            </div>
            <div class="flex-1 min-w-0">
              <a
                [routerLink]="['/artist', song.artist.id]"
                class="text-lg font-bold text-gray-900 hover:text-blue-600 transition-colors truncate block mb-1"
              >
                {{ song.artist.artisticName }}
              </a>
              <p class="text-sm text-gray-500 font-medium">
                <ng-container *ngIf="followersCount !== null; else followersFallback">
                  {{ formatNumber(followersCount || 0) }} seguidores
                </ng-container>
                <ng-template #followersFallback>Seguidores no disponibles</ng-template>
              </p>
            </div>
            <button
              (click)="onToggleFollow()"
              [disabled]="isUpdatingFollow || !song.artist.userId"
              class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all shadow-md hover:shadow-lg font-semibold flex-shrink-0 transform hover:-translate-y-0.5 disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:translate-y-0"
            >
              {{ isFollowingArtist ? 'Siguiendo' : 'Seguir' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-10 lg:mt-12">
      <app-comments-section
        [contentId]="+song.id"
        type="song"
        [contentTitle]="song.title"
        (totalChanged)="onCommentsCountChange($event)"
      ></app-comments-section>
    </div>
  </div>

  <!-- Music Player Global (fixed bottom) -->
  <app-music-player
    [isVisible]="showPlayer"
    (close)="onClosePlayer()"
    (toggleFavorite)="onPlayerToggleFavorite($event)"
  ></app-music-player>
</div>