<section class="bg-white border border-gray-200 shadow-xl rounded-3xl p-6 sm:p-8 space-y-4">
  <div class="flex items-center justify-between gap-4">
    <h2 class="text-2xl font-bold text-gray-900 leading-tight">
      Comentarios <span class="text-gray-500 text-lg">({{ totalElements }})</span>
    </h2>
  </div>

  <div *ngIf="isAuthenticated" class="bg-white border border-gray-200 rounded-2xl p-3 sm:p-4 shadow-sm">
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex gap-3 items-start">
      <!-- Avatar del usuario autenticado -->
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center font-bold text-sm shadow flex-shrink-0 overflow-hidden">
        <img
          *ngIf="currentUserPhoto"
          [src]="currentUserPhoto"
          alt="Tu foto"
          class="w-full h-full object-cover"
        />
        <span *ngIf="!currentUserPhoto">{{ userLetter }}</span>
      </div>

      <div class="flex-1 space-y-2">
        <div class="flex items-start gap-3">
          <div class="relative flex-1">
          <textarea
            formControlName="contenido"
            rows="1"
            class="w-full rounded-xl border border-gray-200 bg-gray-50 px-3 pr-16 py-2.5 text-sm leading-normal focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none h-[44px] min-h-0"
            placeholder="Escribe un comentario..."
            [attr.maxlength]="1000"
          ></textarea>
            <span
              *ngIf="form.get('contenido')?.value as value"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-[11px] text-gray-500"
            >
            {{ (value?.length || 0) }}/1000
          </span>
          </div>

          <button
            type="submit"
            [disabled]="form.invalid || isSubmitting"
            class="inline-flex items-center gap-2 bg-blue-600 text-white px-4 h-[42px] rounded-lg font-semibold shadow hover:bg-blue-700 transition disabled:opacity-60 disabled:cursor-not-allowed"
          >
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h8m-4-4v8m9-4a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Publicar
          </button>
        </div>

        <div class="text-xs text-red-600 font-medium" *ngIf="form.get('contenido')?.invalid && form.get('contenido')?.touched">
          El comentario es obligatorio y máximo 1000 caracteres.
        </div>

        <span *ngIf="isSubmitting" class="text-xs text-blue-600 font-semibold animate-pulse">Enviando...</span>
      </div>
    </form>
  </div>

  <!-- Contenedor con altura fija y scroll -->
  <div class="h-[350px] flex flex-col">
    <div *ngIf="isLoading" class="flex items-center gap-3 text-gray-600 justify-center py-8">
      <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
      <p>Cargando comentarios...</p>
    </div>

    <p *ngIf="!isLoading && errorMessage" class="text-red-600 text-sm font-medium">{{ errorMessage }}</p>

    <ng-container *ngIf="!isLoading && !errorMessage">
      <div *ngIf="comments.length > 0; else noComments" class="flex-1 overflow-y-auto pr-2 space-y-4 scrollbar-custom">
        <article
          *ngFor="let comment of comments; trackBy: trackByCommentId"
          class="flex"
          [ngClass]="{ 'justify-end': isOwn(comment) }"
        >
          <div
            class="relative w-full sm:max-w-3xl border rounded-2xl p-4 sm:p-5 shadow-sm"
            [ngClass]="isOwn(comment) ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'"
          >
            <div class="absolute top-3 right-4 flex items-center gap-2">
              <span class="text-xs text-gray-500">
                {{ comment.fechaPublicacion | date:'medium' }}
                <span *ngIf="comment.editado" class="text-blue-600 font-medium">(editado)</span>
              </span>
              <div class="relative" *ngIf="canManage(comment)">
                <button
                  type="button"
                  (click)="toggleMenu(comment.idComentario)"
                  class="p-2 rounded-full hover:bg-gray-200 text-gray-600"
                >
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.75a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5zm0 6a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5zm0 6a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5z" />
                  </svg>
                </button>

                <div
                  *ngIf="menuOpenFor === comment.idComentario"
                  class="absolute right-0 mt-2 w-32 bg-white border border-gray-200 rounded-lg shadow-md z-10"
                >
                  <button
                    type="button"
                    (click)="startEdit(comment)"
                    class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50"
                  >
                    Editar
                  </button>
                  <button
                    type="button"
                    (click)="deleteComment(comment)"
                    [disabled]="deletingIds.has(comment.idComentario)"
                    class="block w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-50 disabled:opacity-60"
                  >
                    <span *ngIf="deletingIds.has(comment.idComentario)" class="animate-pulse">Borrando...</span>
                    <span *ngIf="!deletingIds.has(comment.idComentario)">Eliminar</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <!-- Avatar con cursor pointer solo si no es propio -->
              <div
                class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 text-white flex items-center justify-center font-semibold flex-shrink-0 overflow-hidden"
                [ngClass]="{ 'cursor-pointer hover:opacity-80 transition-opacity': !isOwn(comment) && comment.slug }"
                (click)="!isOwn(comment) ? navigateToProfile(comment, $event) : null"
              >
                <img
                  *ngIf="getAvatar(comment) as avatar"
                  [src]="avatar"
                  [alt]="getDisplayName(comment)"
                  class="w-full h-full object-cover"
                />
                <span *ngIf="!getAvatar(comment)">{{ getInitials(comment) }}</span>
              </div>

              <div class="flex-1 space-y-1">
                <div class="flex items-center justify-between gap-2">
                  <div class="flex flex-col">
                    <!-- Nombre con cursor pointer solo si no es propio -->
                    <p
                      class="font-semibold text-gray-900"
                      [ngClass]="{ 'cursor-pointer hover:text-blue-600 transition-colors': !isOwn(comment) && comment.slug }"
                      (click)="!isOwn(comment) ? navigateToProfile(comment, $event) : null"
                    >
                      {{ getDisplayName(comment) }}
                    </p>
                  </div>
                </div>

                <div *ngIf="editingCommentId !== comment.idComentario; else editFormTpl" class="text-gray-700 leading-relaxed whitespace-pre-line">
                  {{ comment.contenido }}
                </div>

                <ng-template #editFormTpl>
                  <form [formGroup]="editForm" (ngSubmit)="submitEdit()" class="space-y-2">
                    <textarea
                      formControlName="contenido"
                      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 resize-none"
                      rows="3"
                      [attr.maxlength]="1000"
                    ></textarea>
                    <div class="flex items-center gap-2">
                      <button
                        type="submit"
                        [disabled]="editForm.invalid || isEditing"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition disabled:opacity-60"
                      >
                        Guardar
                      </button>
                      <button
                        type="button"
                        (click)="cancelEdit()"
                        class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-700 border border-gray-300 hover:bg-gray-100 transition"
                      >
                        Cancelar
                      </button>
                      <span *ngIf="isEditing" class="text-xs text-blue-600 font-semibold animate-pulse">Guardando...</span>
                    </div>
                  </form>
                </ng-template>
              </div>
            </div>
          </div>
        </article>
      </div>

      <ng-template #noComments>
        <div class="flex-1 flex items-center justify-center">
          <div class="bg-gray-50 border border-dashed border-gray-200 rounded-2xl p-6 text-center text-gray-600">
            Aún no hay comentarios. Sé el primero en opinar.
          </div>
        </div>
      </ng-template>
    </ng-container>
  </div>
</section>
